<!DOCTYPE html>
<html>
<head>
    <title>PayTM Safe Send</title>
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js" type="text/javascript"></script>
    <style>
        body { font-family: "Segoe UI", "Helvetica Neue", sans-serif; padding: 10px; background-color: #f3f2f1; }
        h3 { border-bottom: 1px solid #c8c6c4; padding-bottom: 5px; margin-top: 0; }
        .card { background: white; padding: 10px; border: 1px solid #d1d1d1; margin-bottom: 5px; }
        .safe { color: green; font-weight: bold; }
        .unsafe { color: #a80000; font-weight: bold; }
        #status { font-style: italic; color: #666; }
    </style>
</head>
<body>
    <h3>Recipient Checker</h3>
    <div id="content">
        <p id="status">Loading Outlook context...</p>
        <ul id="list" style="list-style-type: none; padding: 0;"></ul>
    </div>

    <script>
        // Use older "var" and "function" syntax to prevent crashes in IE11/Old Outlook
        Office.onReady(function(info) {
            document.getElementById("status").innerText = "Ready. Checking...";
            if (info.host === Office.HostType.Outlook) {
                checkRecipients();
            } else {
                document.getElementById("status").innerText = "Error: Not running in Outlook.";
            }
        });

        function checkRecipients() {
            // Get recipients from the "To" field
            Office.context.mailbox.item.to.getAsync(function(result) {
                if (result.status === Office.AsyncResultStatus.Succeeded) {
                    var recipients = result.value;
                    var list = document.getElementById("list");
                    var status = document.getElementById("status");
                    var allSafe = true;

                    // Clear previous list
                    list.innerHTML = "";

                    if (recipients.length === 0) {
                        status.innerText = "No recipients found.";
                        return;
                    }

                    for (var i = 0; i < recipients.length; i++) {
                        var r = recipients[i];
                        var li = document.createElement("li");
                        li.className = "card";
                        
                        // Check if email contains paytm.com
                        if (r.emailAddress.toLowerCase().indexOf("@paytm.com") > -1) {
                            li.innerHTML = "<span class='safe'>\u2705 Internal:</span> " + r.emailAddress;
                        } else {
                            li.innerHTML = "<span class='unsafe'>\u26A0\uFE0F External:</span> " + r.emailAddress;
                            allSafe = false;
                        }
                        list.appendChild(li);
                    }

                    status.innerText = allSafe ? "Safe: All recipients are internal." : "WARNING: External recipients detected.";
                    status.style.color = allSafe ? "green" : "red";
                } else {
                    document.getElementById("status").innerText = "Failed to read recipients. Try again.";
                }
            });
        }
    </script>
</body>
</html>
